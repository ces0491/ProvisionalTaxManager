{% extends "base.html" %}

{% block title %}Transactions{% endblock %}

{% block extra_css %}
<style>
    /* Make category badges more visible with bold font */
    .badge {
        font-weight: 600;
    }

    /* Sticky page header and filters */
    .sticky-header {
        position: sticky;
        top: 56px; /* Height of navbar */
        background: #fff;
        z-index: 100;
        padding-top: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
        margin-left: -12px;
        margin-right: -12px;
        padding-left: 12px;
        padding-right: 12px;
    }

    /* Sticky table header row */
    .sticky-table-header {
        position: sticky;
        background: #fff;
        z-index: 90;
        border-bottom: 2px solid #dee2e6;
        margin-left: -12px;
        margin-right: -12px;
        padding-left: 12px;
        padding-right: 12px;
    }

    .sticky-table-header table {
        margin-bottom: 0;
    }

    /* Resizable table columns */
    .table-responsive {
        overflow-x: auto;
    }

    .resizable-table th {
        position: relative;
        user-select: none;
        background: #fff;
    }

    /* Hide thead in scrollable table body */
    .table-body-container thead {
        display: none;
    }

    .resizable-table th .resizer {
        position: absolute;
        top: 0;
        right: 0;
        width: 5px;
        cursor: col-resize;
        height: 100%;
        background-color: transparent;
    }

    .resizable-table th .resizer:hover {
        background-color: rgba(0, 0, 0, 0.1);
    }

    .resizable-table th.resizing {
        border-right: 2px solid #007bff;
    }

    /* Bulk actions bar */
    .bulk-actions-bar {
        position: sticky;
        background: #f8f9fa;
        z-index: 95;
        padding: 10px 12px;
        border-bottom: 2px solid #dee2e6;
        margin-left: -12px;
        margin-right: -12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Highlight selected rows */
    tr.selected {
        background-color: #e7f1ff !important;
    }

    .row-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    #selectAll {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="sticky-header">
    <div class="row">
        <div class="col-md-8">
            <h1><i class="bi bi-list-ul"></i> All Transactions</h1>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('add_transaction') }}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Add Manual Transaction
            </a>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-md-12">
            <form method="GET" class="row g-2">
                <div class="col-md-3">
                    <label class="form-label small mb-1">Category</label>
                    <select name="category_id" class="form-select form-select-sm">
                        <option value="">All Categories</option>
                        <option value="uncategorized" {% if request.args.get('category_id') == 'uncategorized' %}selected{% endif %}>
                            ⚠️ Uncategorized
                        </option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if request.args.get('category_id')|int == cat.id %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">Start Date</label>
                    <input type="date" name="start_date" class="form-control form-control-sm" value="{{ request.args.get('start_date', '') }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">End Date</label>
                    <input type="date" name="end_date" class="form-control form-control-sm" value="{{ request.args.get('end_date', '') }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">&nbsp;</label>
                    <button type="submit" class="btn btn-primary btn-sm w-100">Filter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk actions bar (hidden by default) -->
<div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
    <div class="d-flex align-items-center gap-3">
        <span id="selectedCount">0 selected</span>
        <select id="bulkCategorySelect" class="form-select form-select-sm" style="width: 200px;">
            <option value="">-- Assign Category --</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
        </select>
        <button type="button" class="btn btn-sm btn-primary" onclick="bulkAssignCategory()">
            <i class="bi bi-tag"></i> Apply Category
        </button>
        <button type="button" class="btn btn-sm btn-danger" onclick="bulkDelete()">
            <i class="bi bi-trash"></i> Delete Selected
        </button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="clearSelection()">
            Cancel
        </button>
    </div>
</div>

<!-- Sticky table header -->
<div class="sticky-table-header" id="stickyTableHeader">
    <table class="table resizable-table mb-0" id="headerTable" style="table-layout: fixed;">
        <colgroup id="headerColgroup">
            <col style="width: 40px;">
            <col style="width: 100px;">
            <col style="width: auto;">
            <col style="width: 120px;">
            <col style="width: 180px;">
            <col style="width: 140px;">
            <col style="width: 120px;">
        </colgroup>
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                <th>Date<div class="resizer"></div></th>
                <th>Description<div class="resizer"></div></th>
                <th>Amount<div class="resizer"></div></th>
                <th>Category<div class="resizer"></div></th>
                <th>Account<div class="resizer"></div></th>
                <th>Actions</th>
            </tr>
        </thead>
    </table>
</div>

<div class="row mt-0">
    <div class="col-md-12">
        <div class="table-body-container">
            <table class="table table-striped table-hover resizable-table" id="bodyTable" style="table-layout: fixed;">
                <colgroup id="bodyColgroup">
                    <col style="width: 40px;">
                    <col style="width: 100px;">
                    <col style="width: auto;">
                    <col style="width: 120px;">
                    <col style="width: 180px;">
                    <col style="width: 140px;">
                    <col style="width: 120px;">
                </colgroup>
                <tbody>
                    {% for trans in transactions.items %}
                    <tr data-id="{{ trans.id }}">
                        <td><input type="checkbox" class="row-checkbox" value="{{ trans.id }}" onchange="updateSelection()"></td>
                        <td>{{ trans.date.strftime('%d %b %Y') }}</td>
                        <td>{{ trans.description }}</td>
                        <td class="{% if trans.amount < 0 %}text-danger{% else %}text-success{% endif %}">
                            R {{ "%.2f"|format(trans.amount|abs) }}
                        </td>
                        <td>
                            {% if trans.category %}
                                <span class="badge badge-{{ trans.category.category_type.replace('_', '-') }}">
                                    {{ trans.category.name }}
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">Uncategorized</span>
                            {% endif %}
                        </td>
                        <td>{{ trans.statement.account.name }}</td>
                        <td class="text-nowrap">
                            {% if trans.is_manual %}
                                <span class="badge bg-info text-dark me-1" title="Manually added">
                                    <i class="bi bi-hand-index"></i>
                                </span>
                            {% endif %}
                            {% if trans.parent_transaction_id %}
                                <span class="badge bg-warning text-dark me-1" title="Split from original">
                                    <i class="bi bi-scissors"></i>
                                </span>
                            {% endif %}
                            <a href="{{ url_for('edit_transaction', id=trans.id, category_id=request.args.get('category_id'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), page=request.args.get('page', 1)) }}"
                               class="btn btn-sm btn-outline-primary"
                               title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{{ url_for('split_transaction', id=trans.id, category_id=request.args.get('category_id'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), page=request.args.get('page', 1)) }}"
                               class="btn btn-sm btn-outline-warning"
                               title="Split into business/personal">
                                <i class="bi bi-scissors"></i>
                            </a>
                            <form method="POST"
                                  action="{{ url_for('delete_transaction', id=trans.id) }}"
                                  style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('Delete this transaction?')"
                                        title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav>
            <ul class="pagination">
                {% if transactions.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('transactions', page=transactions.prev_num, category_id=request.args.get('category_id'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date')) }}">Previous</a>
                </li>
                {% endif %}

                {% for page_num in transactions.iter_pages() %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == transactions.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('transactions', page=page_num, category_id=request.args.get('category_id'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date')) }}">{{ page_num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if transactions.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('transactions', page=transactions.next_num, category_id=request.args.get('category_id'), start_date=request.args.get('start_date'), end_date=request.args.get('end_date')) }}">Next</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set sticky table header position dynamically
    document.addEventListener('DOMContentLoaded', function() {
        const navbar = document.querySelector('.navbar');
        const stickyHeader = document.querySelector('.sticky-header');
        const stickyTableHeader = document.getElementById('stickyTableHeader');

        function updateStickyPositions() {
            const navbarHeight = navbar ? navbar.offsetHeight : 0;
            const stickyHeaderHeight = stickyHeader ? stickyHeader.offsetHeight : 0;
            const totalOffset = navbarHeight + stickyHeaderHeight;

            if (stickyTableHeader) {
                stickyTableHeader.style.top = totalOffset + 'px';
            }
        }

        // Update on load and resize
        updateStickyPositions();
        window.addEventListener('resize', updateStickyPositions);
    });

    // Column resizing functionality with sync between header and body tables
    document.addEventListener('DOMContentLoaded', function() {
        const headerTable = document.getElementById('headerTable');
        const bodyTable = document.getElementById('bodyTable');
        const headerColgroup = document.getElementById('headerColgroup');
        const bodyColgroup = document.getElementById('bodyColgroup');
        if (!headerTable || !bodyTable) return;

        const resizers = headerTable.querySelectorAll('.resizer');
        const headerCols = headerColgroup.querySelectorAll('col');
        const bodyCols = bodyColgroup.querySelectorAll('col');

        let currentResizer = null;
        let currentIndex = -1;
        let startX = 0;
        let startWidth = 0;

        resizers.forEach((resizer, index) => {
            resizer.addEventListener('mousedown', function(e) {
                currentResizer = resizer;
                currentIndex = index;
                startX = e.pageX;
                // Get current width from the col element
                const col = headerCols[index];
                startWidth = col.offsetWidth || parseInt(col.style.width) || 100;

                resizer.parentElement.classList.add('resizing');

                // Prevent text selection while dragging
                document.body.style.userSelect = 'none';

                e.preventDefault();
            });
        });

        document.addEventListener('mousemove', function(e) {
            if (currentResizer === null || currentIndex === -1) return;

            const width = startWidth + (e.pageX - startX);
            if (width > 50) { // Minimum width of 50px
                // Update both colgroups
                headerCols[currentIndex].style.width = width + 'px';
                bodyCols[currentIndex].style.width = width + 'px';
            }
        });

        document.addEventListener('mouseup', function() {
            if (currentResizer) {
                currentResizer.parentElement.classList.remove('resizing');
            }
            currentResizer = null;
            currentIndex = -1;
            document.body.style.userSelect = '';
        });
    });

    // Bulk selection functions
    function getSelectedIds() {
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    function updateSelection() {
        const selected = getSelectedIds();
        const count = selected.length;
        const bulkBar = document.getElementById('bulkActionsBar');
        const countSpan = document.getElementById('selectedCount');

        if (count > 0) {
            bulkBar.style.display = 'block';
            countSpan.textContent = count + ' selected';
        } else {
            bulkBar.style.display = 'none';
        }

        // Update row highlighting
        document.querySelectorAll('.row-checkbox').forEach(cb => {
            const row = cb.closest('tr');
            if (cb.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });

        // Update select all checkbox state
        const allCheckboxes = document.querySelectorAll('.row-checkbox');
        const selectAllCb = document.getElementById('selectAll');
        if (count === allCheckboxes.length && count > 0) {
            selectAllCb.checked = true;
            selectAllCb.indeterminate = false;
        } else if (count > 0) {
            selectAllCb.checked = false;
            selectAllCb.indeterminate = true;
        } else {
            selectAllCb.checked = false;
            selectAllCb.indeterminate = false;
        }
    }

    function toggleSelectAll(cb) {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = cb.checked;
        });
        updateSelection();
    }

    function clearSelection() {
        document.querySelectorAll('.row-checkbox').forEach(cb => {
            cb.checked = false;
        });
        document.getElementById('selectAll').checked = false;
        updateSelection();
    }

    function bulkAssignCategory() {
        const ids = getSelectedIds();
        const categoryId = document.getElementById('bulkCategorySelect').value;

        if (ids.length === 0) {
            alert('No transactions selected');
            return;
        }

        if (!categoryId) {
            alert('Please select a category');
            return;
        }

        if (!confirm(`Assign category to ${ids.length} transaction(s)?`)) {
            return;
        }

        fetch('/api/bulk_update_category', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                transaction_ids: ids,
                category_id: categoryId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }

    function bulkDelete() {
        const ids = getSelectedIds();

        if (ids.length === 0) {
            alert('No transactions selected');
            return;
        }

        if (!confirm(`Delete ${ids.length} transaction(s)? This cannot be undone.`)) {
            return;
        }

        fetch('/api/bulk_delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                transaction_ids: ids
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
</script>
{% endblock %}

