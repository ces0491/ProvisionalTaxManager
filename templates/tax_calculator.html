{% extends "base.html" %}

{% block title %}Tax Calculator - SA Tax Manager{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">
        <i class="bi bi-calculator-fill"></i> Provisional Tax Calculator
    </h1>

    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Calculation Parameters</h5>
                </div>
                <div class="card-body">
                    <form id="taxForm">
                        <div class="mb-3">
                            <label for="startDate" class="form-label">Period Start Date</label>
                            <input type="date" class="form-control" id="startDate" required>
                            <small class="text-muted">
                                First Provisional: 1 Mar | Second Provisional: 1 Sep
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="endDate" class="form-label">Period End Date</label>
                            <input type="date" class="form-control" id="endDate" required>
                            <small class="text-muted">
                                First Provisional: 31 Aug | Second Provisional: 28/29 Feb
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="age" class="form-label">Your Age</label>
                            <input type="number" class="form-control" id="age" value="0" min="0" max="120">
                            <small class="text-muted">
                                Age rebates: 65+ and 75+
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="medicalAid" class="form-label">Medical Aid Members</label>
                            <input type="number" class="form-control" id="medicalAid" value="0" min="0" max="20">
                            <small class="text-muted">
                                0 = None, 1 = Main member only, 2+ = Main + dependents
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="previousPayments" class="form-label">
                                Previous Tax Payments (R)
                            </label>
                            <input type="number" class="form-control" id="previousPayments"
                                   value="0" min="0" step="0.01">
                            <small class="text-muted">
                                Tax already paid this year (for second provisional)
                            </small>
                        </div>

                        <hr>
                        <h6 class="text-muted mb-3">
                            <i class="bi bi-house-door"></i> Home Office Apportionment
                        </h6>

                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="homeOfficeSqm" class="form-label">Office (m²)</label>
                                    <input type="number" class="form-control" id="homeOfficeSqm"
                                           value="22" min="0" step="0.1">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="houseTotalSqm" class="form-label">House (m²)</label>
                                    <input type="number" class="form-control" id="houseTotalSqm"
                                           value="268" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                        <small class="text-muted d-block mb-3">
                            <span id="homeOfficePercentage">8.2</span>% of home expenses are deductible
                        </small>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-calculator"></i> Calculate Tax
                        </button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle"></i> 2025/2026 Tax Rates
                    </h6>
                </div>
                <div class="card-body">
                    <small>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Income (R)</th>
                                    <th>Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>0 - 237,100</td><td>18%</td></tr>
                                <tr><td>237,101 - 370,500</td><td>26%</td></tr>
                                <tr><td>370,501 - 512,800</td><td>31%</td></tr>
                                <tr><td>512,801 - 673,000</td><td>36%</td></tr>
                                <tr><td>673,001 - 857,900</td><td>39%</td></tr>
                                <tr><td>857,901 - 1,817,000</td><td>41%</td></tr>
                                <tr><td>1,817,001+</td><td>45%</td></tr>
                            </tbody>
                        </table>
                        <hr>
                        <strong>Rebates:</strong><br>
                        Primary: R17,235<br>
                        Age 65+: R9,444<br>
                        Age 75+: R3,145
                    </small>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div id="loadingSpinner" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Calculating tax...</p>
            </div>

            <div id="resultsSection" class="d-none">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-check"></i> Tax Calculation Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted">Period Summary</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td>Period Length:</td>
                                        <td class="text-end"><strong id="periodMonths"></strong> months</td>
                                    </tr>
                                    <tr>
                                        <td>Transactions:</td>
                                        <td class="text-end"><strong id="transactionCount"></strong></td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td><strong>Total Income:</strong></td>
                                        <td class="text-end">
                                            <strong>R <span id="periodIncome"></span></strong>
                                        </td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Total Expenses:</strong></td>
                                        <td class="text-end">
                                            <strong>R <span id="periodExpenses"></span></strong>
                                        </td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>Net Profit:</strong></td>
                                        <td class="text-end">
                                            <strong>R <span id="periodProfit"></span></strong>
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted">Annual Estimate</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td>Estimated Annual Income:</td>
                                        <td class="text-end">
                                            <strong>R <span id="annualEstimate"></span></strong>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Tax Before Rebates:</td>
                                        <td class="text-end">R <span id="taxBeforeRebates"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Rebates:</td>
                                        <td class="text-end">- R <span id="rebates"></span></td>
                                    </tr>
                                    <tr>
                                        <td>Medical Credits:</td>
                                        <td class="text-end">- R <span id="medicalCredits"></span></td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Estimated Annual Tax:</strong></td>
                                        <td class="text-end">
                                            <strong>R <span id="annualTax"></span></strong>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Effective Tax Rate:</td>
                                        <td class="text-end"><span id="effectiveRate"></span>%</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="alert alert-success mt-3">
                            <h5 class="alert-heading">
                                <i class="bi bi-cash-coin"></i> Provisional Payment Required
                            </h5>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1">Previous Payments:</p>
                                    <h6>R <span id="previousPaymentsDisplay"></span></h6>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>Amount Due:</strong>
                                    </p>
                                    <h3 class="mb-0 text-success">
                                        R <span id="provisionalPayment"></span>
                                    </h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Summary Card -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-list-check"></i> Transaction Summary
                            <small class="float-end">Tax Year: <span id="taxYear"></span></small>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col">
                                <div class="border rounded p-2 bg-light">
                                    <small class="text-muted d-block">Income</small>
                                    <strong class="text-success" id="incomeCount">0</strong>
                                </div>
                            </div>
                            <div class="col">
                                <div class="border rounded p-2 bg-light">
                                    <small class="text-muted d-block">Business</small>
                                    <strong class="text-primary" id="businessCount">0</strong>
                                </div>
                            </div>
                            <div class="col">
                                <div class="border rounded p-2 bg-light">
                                    <small class="text-muted d-block">Personal</small>
                                    <strong class="text-secondary" id="personalCount">0</strong>
                                </div>
                            </div>
                            <div class="col">
                                <div class="border rounded p-2 bg-light">
                                    <small class="text-muted d-block">Excluded</small>
                                    <strong class="text-muted" id="excludedCount">0</strong>
                                </div>
                            </div>
                            <div class="col">
                                <div class="border rounded p-2 bg-light">
                                    <small class="text-muted d-block">Total</small>
                                    <strong id="totalCount">0</strong>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                <strong>Income</strong> and <strong>Business Expenses</strong> are used in tax calculation.
                                Personal expenses and excluded items are not tax-deductible.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Income Breakdown -->
                <div class="card mb-4" id="incomeBreakdownCard">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-arrow-down-circle"></i> Income Breakdown
                            <span class="badge bg-light text-success float-end" id="incomeTotalBadge">R 0.00</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="incomeBreakdown"></div>
                    </div>
                </div>

                <!-- Business Expense Breakdown -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-briefcase"></i> Business Expenses (Tax Deductible)
                            <span class="badge bg-light text-primary float-end" id="expenseTotalBadge">R 0.00</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="expenseBreakdown"></div>
                    </div>
                </div>

                <!-- Personal Expenses (Not Deductible) -->
                <div class="card mb-4" id="personalBreakdownCard">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-person"></i> Personal Expenses (Not Deductible)
                            <span class="badge bg-light text-secondary float-end" id="personalTotalBadge">R 0.00</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="personalBreakdown"></div>
                    </div>
                </div>

                <!-- Excluded Transactions -->
                <div class="card mb-4" id="excludedBreakdownCard">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-x-circle"></i> Excluded (Not Counted)
                            <span class="badge bg-light text-dark float-end" id="excludedTotalBadge">R 0.00</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="excludedBreakdown"></div>
                    </div>
                </div>

                <!-- Home Office Apportionment Details -->
                <div class="card mb-4" id="apportionmentCard">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="bi bi-house-door"></i> Home Office Apportionment
                            <span class="badge bg-dark text-warning float-end" id="apportionmentPercentBadge">0%</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">
                            <strong>Office:</strong> <span id="apportionmentOfficeSqm">0</span>m² |
                            <strong>House:</strong> <span id="apportionmentHouseSqm">0</span>m² |
                            <strong>Deductible:</strong> <span id="apportionmentPercentage">0</span>%
                        </p>
                        <p class="small text-muted mb-3">
                            The following home-related expenses are reduced to <span id="apportionmentPercentage2">0</span>% of their full value:
                        </p>
                        <div id="apportionmentBreakdown"></div>
                        <div class="alert alert-warning mt-3 mb-0 small" id="apportionmentSavingsAlert">
                            <strong>Total reduction:</strong> R <span id="apportionmentReduction">0.00</span>
                            (non-deductible portion of home expenses)
                        </div>
                    </div>
                </div>
            </div>

            <div id="errorSection" class="alert alert-danger d-none">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle"></i> Error
                </h5>
                <p id="errorMessage"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('taxForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Show loading, hide results/errors
    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('resultsSection').classList.add('d-none');
    document.getElementById('errorSection').classList.add('d-none');

    // Get form data
    const formData = {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        age: document.getElementById('age').value,
        medical_aid_members: document.getElementById('medicalAid').value,
        previous_payments: document.getElementById('previousPayments').value,
        home_office_sqm: document.getElementById('homeOfficeSqm').value,
        house_total_sqm: document.getElementById('houseTotalSqm').value
    };

    try {
        const response = await fetch('/api/calculate_tax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            displayResults(data.calculation, data.transaction_count);
        } else {
            showError(data.error || 'Unknown error occurred');
        }
    } catch (error) {
        showError('Failed to calculate tax: ' + error.message);
    } finally {
        document.getElementById('loadingSpinner').classList.add('d-none');
    }
});

function displayResults(calc, transCount) {
    // Period summary
    document.getElementById('periodMonths').textContent = calc.period_months;
    document.getElementById('transactionCount').textContent = transCount;
    document.getElementById('periodIncome').textContent = formatCurrency(calc.period_income);
    document.getElementById('periodExpenses').textContent = formatCurrency(calc.period_expenses);
    document.getElementById('periodProfit').textContent = formatCurrency(calc.period_profit);

    // Annual estimate
    document.getElementById('annualEstimate').textContent = formatCurrency(calc.annual_estimate);
    document.getElementById('taxBeforeRebates').textContent =
        formatCurrency(calc.tax_breakdown.tax_before_rebates);
    document.getElementById('rebates').textContent =
        formatCurrency(calc.tax_breakdown.rebates);
    document.getElementById('medicalCredits').textContent =
        formatCurrency(calc.tax_breakdown.medical_credits);
    document.getElementById('annualTax').textContent =
        formatCurrency(calc.estimated_annual_tax);
    document.getElementById('effectiveRate').textContent = calc.effective_rate;

    // Provisional payment
    document.getElementById('previousPaymentsDisplay').textContent =
        formatCurrency(calc.previous_payments);
    document.getElementById('provisionalPayment').textContent =
        formatCurrency(calc.provisional_payment);

    // Tax year
    document.getElementById('taxYear').textContent = calc.tax_year + '/' + (calc.tax_year + 1);

    // Transaction counts
    const counts = calc.transaction_counts;
    document.getElementById('incomeCount').textContent = counts.income;
    document.getElementById('businessCount').textContent = counts.business_expense;
    document.getElementById('personalCount').textContent = counts.personal_expense;
    document.getElementById('excludedCount').textContent = counts.excluded;
    document.getElementById('totalCount').textContent = counts.total;

    // Income breakdown
    displayBreakdown('incomeBreakdown', calc.income_breakdown, 'No income transactions found.');
    document.getElementById('incomeTotalBadge').textContent = 'R ' + formatCurrency(calc.period_income);
    toggleCard('incomeBreakdownCard', Object.keys(calc.income_breakdown).length > 0);

    // Business expense breakdown
    displayBreakdown('expenseBreakdown', calc.expense_breakdown, 'No business expenses found.');
    document.getElementById('expenseTotalBadge').textContent = 'R ' + formatCurrency(calc.period_expenses);

    // Personal expense breakdown
    displayBreakdown('personalBreakdown', calc.personal_breakdown, 'No personal expenses found.');
    document.getElementById('personalTotalBadge').textContent = 'R ' + formatCurrency(calc.total_personal_expenses);
    toggleCard('personalBreakdownCard', Object.keys(calc.personal_breakdown).length > 0);

    // Excluded breakdown
    displayBreakdown('excludedBreakdown', calc.excluded_breakdown, 'No excluded transactions found.');
    document.getElementById('excludedTotalBadge').textContent = 'R ' + formatCurrency(calc.total_excluded);
    toggleCard('excludedBreakdownCard', Object.keys(calc.excluded_breakdown).length > 0);

    // Home office apportionment
    displayApportionment(calc.home_office);

    // Show results
    document.getElementById('resultsSection').classList.remove('d-none');
}

function displayApportionment(homeOffice) {
    // Update summary values
    document.getElementById('apportionmentOfficeSqm').textContent = homeOffice.office_sqm;
    document.getElementById('apportionmentHouseSqm').textContent = homeOffice.house_sqm;
    document.getElementById('apportionmentPercentage').textContent = homeOffice.percentage;
    document.getElementById('apportionmentPercentage2').textContent = homeOffice.percentage;
    document.getElementById('apportionmentPercentBadge').textContent = homeOffice.percentage + '%';
    document.getElementById('apportionmentReduction').textContent = formatCurrency(homeOffice.total_reduction);

    // Build apportionment breakdown table
    const container = document.getElementById('apportionmentBreakdown');
    const detail = homeOffice.detail;

    if (!detail || Object.keys(detail).length === 0) {
        container.innerHTML = '<p class="text-muted mb-0">No home-related expenses found in this period.</p>';
        toggleCard('apportionmentCard', false);
        return;
    }

    let html = '<table class="table table-sm table-striped mb-0">';
    html += '<thead><tr><th>Category</th><th class="text-end">Full Amount</th><th class="text-end">Deductible (' + homeOffice.percentage + '%)</th><th class="text-end">Reduction</th></tr></thead>';
    html += '<tbody>';

    // Sort by full amount descending
    const sorted = Object.entries(detail).sort((a, b) =>
        parseFloat(b[1].full) - parseFloat(a[1].full)
    );

    for (const [category, vals] of sorted) {
        html += `<tr>
            <td>${category}</td>
            <td class="text-end text-muted"><s>R ${formatCurrency(vals.full)}</s></td>
            <td class="text-end text-success">R ${formatCurrency(vals.apportioned)}</td>
            <td class="text-end text-danger">-R ${formatCurrency(vals.reduction)}</td>
        </tr>`;
    }

    html += '</tbody></table>';
    container.innerHTML = html;
    toggleCard('apportionmentCard', true);
}

function displayBreakdown(containerId, breakdown, emptyMessage) {
    const container = document.getElementById(containerId);

    if (!breakdown || Object.keys(breakdown).length === 0) {
        container.innerHTML = `<p class="text-muted mb-0">${emptyMessage}</p>`;
        return;
    }

    let html = '<table class="table table-sm table-striped mb-0">';
    html += '<thead><tr><th>Category</th><th class="text-end">Amount</th></tr></thead>';
    html += '<tbody>';

    // Sort by amount descending
    const sorted = Object.entries(breakdown).sort((a, b) =>
        parseFloat(b[1]) - parseFloat(a[1])
    );

    for (const [category, amount] of sorted) {
        html += `<tr>
            <td>${category}</td>
            <td class="text-end">R ${formatCurrency(amount)}</td>
        </tr>`;
    }

    html += '</tbody></table>';
    container.innerHTML = html;
}

function toggleCard(cardId, show) {
    const card = document.getElementById(cardId);
    if (card) {
        card.style.display = show ? 'block' : 'none';
    }
}

function formatCurrency(value) {
    const num = parseFloat(value);
    return num.toLocaleString('en-ZA', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorSection').classList.remove('d-none');
}

// Set default dates for first provisional period (Mar 1 - Aug 31)
window.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    const year = now.getFullYear();

    // Default to current year's first provisional period
    document.getElementById('startDate').value = `${year}-03-01`;
    document.getElementById('endDate').value = `${year}-08-31`;

    // Update home office percentage when values change
    updateHomeOfficePercentage();
});

// Update home office percentage display dynamically
function updateHomeOfficePercentage() {
    const officeSqm = parseFloat(document.getElementById('homeOfficeSqm').value) || 0;
    const houseSqm = parseFloat(document.getElementById('houseTotalSqm').value) || 1;
    const percentage = ((officeSqm / houseSqm) * 100).toFixed(1);
    document.getElementById('homeOfficePercentage').textContent = percentage;
}

document.getElementById('homeOfficeSqm').addEventListener('input', updateHomeOfficePercentage);
document.getElementById('houseTotalSqm').addEventListener('input', updateHomeOfficePercentage);
</script>
{% endblock %}
