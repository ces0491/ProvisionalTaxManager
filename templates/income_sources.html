{% extends "base.html" %}

{% block title %}Income Sources - SA Tax Manager{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">
        <i class="bi bi-cash-stack"></i> Manage Income Sources & Categorization Rules
    </h1>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Income Source Patterns</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Add patterns to automatically identify income from different sources
                        (e.g., client names, payment platforms, deposit descriptions).
                    </p>

                    {% if income_rules %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Pattern</th>
                                    <th>Type</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rule in income_rules %}
                                <tr>
                                    <td><code>{{ rule.pattern }}</code></td>
                                    <td>
                                        {% if rule.is_regex %}
                                            <span class="badge bg-info">Regex</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Text</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ rule.priority }}</td>
                                    <td>
                                        {% if rule.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-warning">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-warning"
                                                onclick="toggleRule({{ rule.id }})">
                                            <i class="bi bi-toggle-on"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="deleteRule({{ rule.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        No income source patterns configured yet. Add your first pattern below!
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">All Categorization Rules</h5>
                </div>
                <div class="card-body">
                    {% if all_rules %}
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Pattern</th>
                                    <th>Category</th>
                                    <th>Type</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rule in all_rules %}
                                <tr>
                                    <td><code>{{ rule.pattern }}</code></td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if rule.category.category_type == 'income' else 'primary' if rule.category.category_type == 'business_expense' else 'warning' }}">
                                            {{ rule.category.name }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if rule.is_regex %}
                                            <span class="badge bg-info">Regex</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Text</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ rule.priority }}</td>
                                    <td>
                                        {% if rule.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-warning">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-warning"
                                                onclick="toggleRule({{ rule.id }})">
                                            <i class="bi bi-toggle-on"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="deleteRule({{ rule.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No categorization rules defined.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Add New Pattern</h5>
                </div>
                <div class="card-body">
                    <form id="addPatternForm">
                        <div class="mb-3">
                            <label for="category_id" class="form-label">
                                Category <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="category_id"
                                    name="category_id" required>
                                <option value="">-- Select Category --</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}"
                                            {% if category.name == 'Income' %}selected{% endif %}>
                                        {{ category.name }}
                                        ({{ category.category_type.replace('_', ' ').title() }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="pattern" class="form-label">
                                Pattern <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="pattern"
                                   name="pattern" required
                                   placeholder="e.g., ACME CORP, PAYPAL, CLIENT NAME">
                            <small class="text-muted">
                                Text to match in transaction descriptions (case-insensitive)
                            </small>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       id="is_regex" name="is_regex">
                                <label class="form-check-label" for="is_regex">
                                    Use Regular Expression
                                </label>
                            </div>
                            <small class="text-muted">
                                Enable for advanced pattern matching (e.g., CLIENT.*PAYMENT)
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="priority" class="form-label">Priority</label>
                            <input type="number" class="form-control" id="priority"
                                   name="priority" value="100" min="0" max="1000">
                            <small class="text-muted">
                                Higher priority rules are checked first (default: 100)
                            </small>
                        </div>

                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-plus-circle"></i> Add Pattern
                        </button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-lightbulb"></i> Examples
                    </h6>
                </div>
                <div class="card-body">
                    <strong>Income Sources:</strong>
                    <ul class="small mb-2">
                        <li><code>PAYPAL</code> - PayPal deposits</li>
                        <li><code>STRIPE</code> - Stripe payments</li>
                        <li><code>CLIENT ABC</code> - Specific client</li>
                        <li><code>FREELANCE.*PAYMENT</code> (regex) - Various freelance platforms</li>
                    </ul>

                    <strong>Other Patterns:</strong>
                    <ul class="small mb-0">
                        <li><code>STARBUCKS</code> - Coffee expenses</li>
                        <li><code>UBER</code> - Transport</li>
                        <li><code>AMAZON</code> - Office supplies</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('addPatternForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
        pattern: document.getElementById('pattern').value,
        category_id: document.getElementById('category_id').value,
        is_regex: document.getElementById('is_regex').checked,
        priority: document.getElementById('priority').value
    };

    try {
        const response = await fetch('/api/income_source/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            alert('Pattern added successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to add pattern: ' + error.message);
    }
});

async function toggleRule(ruleId) {
    try {
        const response = await fetch(`/api/income_source/${ruleId}/toggle`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert('Failed to toggle rule');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this rule?')) {
        return;
    }

    try {
        const response = await fetch(`/api/income_source/${ruleId}/delete`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            alert('Rule deleted successfully!');
            location.reload();
        } else {
            alert('Failed to delete rule');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}
